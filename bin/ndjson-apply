#!/usr/bin/env node
const path = require('path')
let args = process.argv.slice(2)
const showDiff = args.includes('--diff')
const filterOnly = args.includes('--filter')
args = args.filter(arg => arg[0] !== '-')
const [ fnModulePath, key ] = args

if (!fnModulePath) throw new Error('missing function module path')

const resolvedPath = path.resolve(fnModulePath)
let transformFn = require(resolvedPath)

if (key) {
  if (transformFn[key] == null) throw new Error(`"${key}" not found on ${fnModulePath} exported object`)
  if (typeof transformFn[key] !== 'function') throw new Error(`${fnModulePath}#${key} isnt a function: ${typeof transformFn[key]}`)
  transformFn = transformFn[key]
}

if (typeof transformFn !== 'function') throw new Error(`${resolvedPath} doesn't export a function`)

const split = require('split')
const through = require('through')
const { isAsyncFunction } = require('../lib/utils')
const lineTransformers = require('../lib/line_transformers')
const handleErrors = require('../lib/handle_errors')

const transformer = isAsyncFunction(transformFn) ? lineTransformers.async : lineTransformers.sync

process.stdin
.pipe(split())
.pipe(through(transformer(transformFn, showDiff, filterOnly)))
.pipe(process.stdout)
.on('error', handleErrors)
